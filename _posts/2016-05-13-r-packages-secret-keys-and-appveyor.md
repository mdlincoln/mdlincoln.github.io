---
layout: "post"
title: "R packages, secret keys, and testing on Appveyor"
date: "2016-05-13 17:32"
comments: true
tags:
- Code
- R
---

In the wake of [defending my dissertation](https://twitter.com/matthewdlincoln/status/722811630791356416) and [landing a new job](https://twitter.com/matthewdlincoln/status/730083315189960705), I've been relaxing by polishing up an R package, [PastecR](https://github.com/mdlincoln/PastecR) that wraps the API for [Pastec](http://pastec.io/), an open-source fuzzy image matching engine.

The creator of Pastec recently launched a [hosted version of the service of the service](https://api.pastec.io).
I've just updated PastecR to talk to both self-hosted instances of Pastec, as well as the SaaS instance at api.pastec.io.

Because I use both [Travis-CI](https://travis-ci.org) as well as [Appveyor](https://ci.appveyor.com), I needed to jump through hoops to make sure that I could provide the CI services with encrypted versions of my api.pastec.io keys, while also making sure that I didn't send extraneous keys (encrypted or not) to CRAN.

[Jennifer Bryan has a great rundown of how to work with encrypted keys on Travis](https://rawgit.com/jennybc/googlesheets/master/vignettes/managing-auth-tokens.html#encrypting-tokens-for-hosted-continuous-integration).
But what about Appveyor?

## Save key objects as .rda

In order to run tests against the hosted version of Pastec, I need to provide R with keys to my account on the server.
api.pastec.io requires both an `index_id` as well as an `auth_key`.
Encrypting multiple files is a bit of a pain on both Travis and Appveyor, so I sidestepped this by `save()`-ing both strings into one `.rda` object that I can easily load again.

``` r
# Save your keys BUT DO NOT SAVE THIS CODE
index_id <- "XXXXXXXXXXXXXXXXXXXX"
auth_key <- "XXXXXXXXXXXXXXXXXXXX"

save(index_id, auth_key, file = "tests/testthat/av_hosted_keys.rda")
# NOW DELETE THIS CODE!
```

If you are also running Travis-CI, you'll need to save a different file to encrypt/decrypt via Travis; hence the prefix `av_` on the `.rda` file.

You'll want to load this code before running tests BUT you also want to make sure that CRAN does not try to load this code while building your package:

``` r
if (identical(Sys.getenv("NOT_CRAN"), "true")) {
  load("av_hosted_keys.rda")
  x <- some_server_function(index_id, auth_key)
}

# ...a bunch of tests...
```

## Encrypt your keys and setup appveyor.yml

[Appveyor uses a little tool called `secure-file`](https://www.appveyor.com/docs/how-to/secure-files) to encrypt files for its service.
This installs via [nuget](), which you can install with [homebrew]() if you are developing on OS X.

```sh
# Odd tip: nuget downloads files to your current working directory, so make sure
# to cd elsewhere lest you add an errant executable to your R package
cd
brew install nuget
nuget install secure-file -ExcludeVersion
```

Now `cd` back to your package directory, and encrypt.
`secure-file` requires a secret string.
Let's use `AV2016SECRET` in this example:

```sh
# On OS X, you'll run secure-file.exe via mono, which homebrew will install
# alongside nuget
mono ~/secure-file/tools/secure-file.exe -encrypt tests/testthat/av_hosted_keys.rda -out tests/testthat/av_hosted_keys.rda.enc -secret AV2016SECRET
```

You'll now have `av_hosted_keys.rda.enc` sitting in `tests/testthat`.
In order to decrypt this file when it goes to Appveyor, we need to modify the defaul `appveyor.yml` generated by `devtools::use_appveyor()`.

Change

```yml
install:
  ps: Boostratp
```

to

```yml
install:
  - nuget install secure-file -ExcludeVersion
  - secure-file\tools\secure-file -decrypt tests/testthat/av_hosted_keys.rda.enc -secret %my_secret% -out tests/testthat/hosted_keys.rda
  - ps: Bootstrap
```

See `%my_secret%` in there?
That's a secret environment variable that we need to provide to Appveyor.
To do so, go to Appveyor's [config data encryption tool](https://ci.appveyor.com/tools/encrypt) and enter the secret we used above, `AV2016SECRET`:

![Appveyor config data encryption tool.](/assets/images-display/appveyor_encrypt.png)

Now add the following lines to `appveyor.yml`, using the encrypted version of the secret phrase:

```yml
environment:
  my_secret:
    secure: NhtVX5iFHBg8Ftkc9sdnQQ==
```

## `.ignore` the right things
